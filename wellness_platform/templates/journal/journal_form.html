{% extends 'base.html' %}

{% block title %}{% if is_edit %}Edit{% else %}New{% endif %} Entry - PulseWell{% endblock %}

{% block content %}
<div class="min-h-screen bg-emerald-950 dark:bg-gray-900 p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
                {% if is_edit %}‚úèÔ∏è Edit Entry{% else %}‚úçÔ∏è New Journal Entry{% endif %}
            </h1>
            <p class="text-gray-600 dark:text-gray-400">
                {% if is_edit %}Update your thoughts{% else %}Write freely and express yourself{% endif %}
            </p>
        </div>

        <form method="post" class="space-y-6">
            {% csrf_token %}

            <!-- Title Field -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-700">
                <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    {{ form.title.label }}
                </label>
                {{ form.title }}
                {% if form.title.errors %}
                    <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ form.title.errors.0 }}</p>
                {% endif %}
                {% if form.title.help_text %}
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">{{ form.title.help_text }}</p>
                {% endif %}
            </div>

            <!-- Editor with Preview Toggle -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
                <!-- Toolbar -->
                <div class="bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 p-4">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center space-x-2">
                            <button type="button" onclick="togglePreview()" id="preview-toggle"
                                    class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium transition">
                                üëÅÔ∏è Preview
                            </button>
                            <span class="text-sm text-gray-600 dark:text-gray-400">Markdown supported</span>
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            <span id="word-count">0</span> words
                        </div>
                    </div>
                </div>

                <!-- Editor and Preview Container -->
                <div class="relative">
                    <!-- Markdown Editor -->
                    <div id="editor-container" class="p-6">
                        <label for="{{ form.content.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ form.content.label }}
                        </label>
                        {{ form.content }}
                        {% if form.content.errors %}
                            <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ form.content.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Markdown Preview -->
                    <div id="preview-container" class="hidden p-6 prose prose-lg dark:prose-invert max-w-none">
                        <div id="markdown-preview" class="text-gray-900 dark:text-gray-100"></div>
                    </div>
                </div>

                <!-- Markdown Guide -->
                <div class="bg-blue-50 dark:bg-blue-900/20 border-t border-blue-200 dark:border-blue-800 p-4">
                    <details class="cursor-pointer">
                        <summary class="text-sm font-medium text-blue-900 dark:text-blue-300">üìñ Markdown Guide</summary>
                        <div class="mt-3 text-sm text-blue-800 dark:text-blue-400 space-y-2">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <div><code># Heading 1</code> - Large heading</div>
                                <div><code>## Heading 2</code> - Medium heading</div>
                                <div><code>**bold text**</code> - Bold text</div>
                                <div><code>*italic text*</code> - Italic text</div>
                                <div><code>- List item</code> - Bullet list</div>
                                <div><code>1. List item</code> - Numbered list</div>
                                <div><code>> Quote</code> - Blockquote</div>
                                <div><code>`code`</code> - Inline code</div>
                            </div>
                        </div>
                    </details>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center justify-end space-x-4">
                <a href="{% if is_edit %}{% url 'journal:journal_detail' entry.pk %}{% else %}{% url 'journal:journal_list' %}{% endif %}"
                   class="px-6 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition duration-200 font-medium">
                    Cancel
                </a>
                <button type="submit"
                        class="px-8 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:from-purple-700 hover:to-pink-700 transition duration-200 shadow-md hover:shadow-lg font-medium">
                    {% if is_edit %}üíæ Save Changes{% else %}üìù Create Entry{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Markdown Parser (marked.js from CDN) -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    const editor = document.getElementById('markdown-editor');
    const previewContainer = document.getElementById('preview-container');
    const editorContainer = document.getElementById('editor-container');
    const previewContent = document.getElementById('markdown-preview');
    const previewToggle = document.getElementById('preview-toggle');
    const wordCountSpan = document.getElementById('word-count');

    let showingPreview = false;

    // Configure marked for safe rendering
    marked.setOptions({
        breaks: true,
        gfm: true,
        sanitize: false, // We trust user input for their own journal
        smartLists: true,
        smartypants: true
    });

    function updateWordCount() {
        const text = editor.value.trim();
        const words = text ? text.split(/\s+/).length : 0;
        wordCountSpan.textContent = words;
    }

    function togglePreview() {
        showingPreview = !showingPreview;

        if (showingPreview) {
            // Show preview
            const markdown = editor.value;
            previewContent.innerHTML = marked.parse(markdown);
            editorContainer.classList.add('hidden');
            previewContainer.classList.remove('hidden');
            previewToggle.textContent = '‚úèÔ∏è Edit';
            previewToggle.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
            previewToggle.classList.add('bg-green-600', 'hover:bg-green-700');
        } else {
            // Show editor
            editorContainer.classList.remove('hidden');
            previewContainer.classList.add('hidden');
            previewToggle.textContent = 'üëÅÔ∏è Preview';
            previewToggle.classList.remove('bg-green-600', 'hover:bg-green-700');
            previewToggle.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
        }
    }

    // Update word count on input
    editor.addEventListener('input', updateWordCount);

    // Initialize word count
    updateWordCount();
</script>

<style>
    /* Custom prose styling for preview */
    .prose {
        max-width: none;
    }
    .prose h1 {
        font-size: 2.25em;
        font-weight: 800;
        margin-top: 0;
        margin-bottom: 0.8888889em;
        line-height: 1.1111111;
    }
    .prose h2 {
        font-size: 1.5em;
        font-weight: 700;
        margin-top: 2em;
        margin-bottom: 1em;
        line-height: 1.3333333;
    }
    .prose h3 {
        font-size: 1.25em;
        font-weight: 600;
        margin-top: 1.6em;
        margin-bottom: 0.6em;
        line-height: 1.6;
    }
    .prose p {
        margin-top: 1.25em;
        margin-bottom: 1.25em;
    }
    .prose blockquote {
        font-weight: 500;
        font-style: italic;
        border-left-width: 0.25rem;
        border-left-color: #e5e7eb;
        quotes: "\201C""\201D""\2018""\2019";
        margin-top: 1.6em;
        margin-bottom: 1.6em;
        padding-left: 1em;
    }
    .dark .prose blockquote {
        border-left-color: #374151;
    }
    .prose ul, .prose ol {
        margin-top: 1.25em;
        margin-bottom: 1.25em;
        padding-left: 1.625em;
    }
    .prose li {
        margin-top: 0.5em;
        margin-bottom: 0.5em;
    }
    .prose code {
        background-color: #f3f4f6;
        padding: 0.2em 0.4em;
        border-radius: 0.25rem;
        font-size: 0.875em;
    }
    .dark .prose code {
        background-color: #1f2937;
    }
</style>
{% endblock %}
